<html>
<head>
	<meta charset='utf-8'>
	<meta id="viewport" name="viewport" content ="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />	
	<title>Test</title>
	<script src="../contrib/modernizer.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Exo+2:200' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="../contrib/jquery-ui.css"></link>
	<script src="../contrib/jquery-1.9.1.js"></script>
	<script src="../contrib/jquery-ui.js"></script>
	<script src="../contrib/hammerjs/hammer.js"></script>
	<script src="../contrib/hammerjs/plugins/hammer.fakemultitouch.js"></script>
	<script src="../contrib/hammerjs/plugins/hammer.showtouches.js"></script>
	<style media="screen">

	.icons { display: none; }

	* {
	    -webkit-touch-callout:none;
	    -webkit-user-select:none;
	    -moz-user-select:none;
	    -ms-user-select:none;
	    user-select:none;
	}
	
	body {
		background-color: #fefefe;
		width: 100%;
		height: 100%;
		overflow: hidden;
		font-family: arial,verdana,sans-serif;
	}

	.drum-wrapper {
		position: relative;
		float: left;
		overflow: hidden;
		height: 145px;
		width:100px;
		border: 1px solid #CCC;
	}
	.container {
		width: 100%;
		height: 25px;
		position: absolute;
		top: 60px;
		left: 0px;
		-webkit-perspective: 1100px;
		-moz-perspective: 1100px;
		-o-perspective: 1100px;
		perspective: 1100px;
	}

	.drum {
		width: 100%;
		height: 100%;
		position: absolute;
		top: 0px;
		left: 0px;
		-webkit-transform-style: preserve-3d;
		-moz-transform-style: preserve-3d;
		-o-transform-style: preserve-3d;
		transform-style: preserve-3d;
	}

	.drum figure {
		-webkit-backface-visibility: hidden;
		-moz-backface-visibility: hidden;
		-o-backface-visibility: hidden;
		backface-visibility: hidden;
		display: block;
		position: absolute;
		height: 25px;
		left: 0px;
		top: 0px;
		line-height: 25px;
		color: black;
		margin: 0px;
		font-family: 'Exo 2', sans-serif;
		text-overflow: ellipsis;
		white-space: nowrap;
		overflow: hidden;
		width: 100px;
	}
	</style>
</head>
<body>
<select id="country" name="countries"><option value="GL">Greenland</option><option value="DJ">Djibouti</option><option value="JM">Jamaica</option><option value="AT">Austria</option><option value="PG">Papua New Guinea</option><option value="KI">Kiribati</option><option value="SZ">Swaziland</option><option value="YT">Mayotte</option><option value="BN">Brunei</option><option value="CD">Congo Democratic Republic</option><option value="ZM">Zambia</option><option value="AO">Angola</option><option value="BW">Botswana</option><option value="ZW">Zimbabwe</option><option value="VC">Saint Vincent and the Grenadines</option><option value="PR">Puerto Rico</option><option value="JP">Japan</option><option value="NA">Namibia</option><option value="SH">Saint Helena Ascension and Tristan da Cunha</option><option value="TJ">Tajikistan</option><option value="LC">Saint Lucia</option><option value="MA">Morocco</option><option value="VU">Vanuatu</option><option value="MT">Malta</option><option value="SV">El Salvador</option><option value="MN">Mongolia</option><option value="MP">Northern Mariana Islands</option><option value="IT">Italy</option><option value="RE">Réunion</option><option value="WS">Samoa</option><option value="CW">Curaçao</option><option value="FR">France</option><option value="EG">Egypt</option><option value="UZ">Uzbekistan</option><option value="PW">Palau</option><option value="LR">Liberia</option><option value="TK">Tokelau</option><option value="RW">Rwanda</option><option value="UM">United States Minor Outlying Islands</option><option value="TN">Tunisia</option><option value="BE">Belgium</option><option value="EE">Estonia</option><option value="CK">Cook Islands</option><option value="BY">Belarus</option><option value="LS">Lesotho</option><option value="KR">Korea South</option><option value="NO">Norway</option><option value="SA">Saudi Arabia</option><option value="ZA">South Africa</option></select>
<select id="n45" name="numbers"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option><option value="36">36</option><option value="37">37</option><option value="38">38</option>
<option value="39">39</option><option value="40">40</option><option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option></select>
<script>
	"use strict";

	Hammer.plugins.fakeMultitouch();
	Hammer.plugins.showTouches();

	$(function() {
		$.widget( "drumjs.drum", {
			drumfactory: function (data, i) {
				return new (function (data, i) { 
					this.data = data;
					this.index = i;
					this.getText = function () {
						return this.data[this.index].text;
					}	
					this.getValue = function () {
						return this.data[this.index].value;
					}
				})(data, i);
			},
			panelfactory: function (index, dataModel, parent) {
				return new (function (index, dataModel, parent) {
					this.angle = parent.theta * index;
					this.index = index;
					this.dataModel = dataModel;
					this.elem = document.createElement('figure');

					this.setText = function () {
						$(this.elem).text(this.dataModel.getText());
					};

					this.update = function (data_index) {
						if (this.dataModel.index != data_index) {
							this.dataModel.index = data_index;
							this.setText();
						}
					};

					$(this.elem).addClass('a' + this.angle);
					$(this.elem).css('opacity', '0.5');
					$(this.elem).css(parent.transformProp, parent.rotateFn + '(' + -this.angle + 'deg) translateZ(' + parent.radius + 'px)');
					$(parent.element).append(this.elem);
					this.setText();
				})(index, dataModel, parent);
			},
			init: function ( el, data, panelfactory, drumfactory ) {
				return new (function(el, data, panelfactory, drumfactory) { 
					this.element = el;
					this.data = data;

					this.panelCount = 24;
					this.rotateFn = 'rotateX';
					this.transformProp = Modernizr.prefixed('transform');
					
					this.rotation = 0;
					this.distance = 0;
					this.last_angle = 0;
					
					this.theta = 360 / this.panelCount;
					this.radius = Math.round( ( this.element['offsetHeight'] / 2 ) / Math.tan( Math.PI / this.panelCount ) );

					this.mapping = [];

					this.update = function (selected) {
						var c, list = [], pc = this.panelCount, ph = this.panelCount / 2;
						var i = selected.index; 
						var j = selected.dataModel.index;
						for (var k=j-ph; k<=j+ph-1; k++) {
							c = k;
							if (k < 0)
								c = this.data.length+k;
							if (k > this.data.length-1)
								c = k-this.data.length;
							list.push(c);
						}
						var t = list.slice(ph-i); 
						list = t.concat(list.slice(0, pc - t.length));
						for (var i=0; i<this.mapping.length; i++) {
							this.mapping[i].update(list[i]);
						}
					};

					this.transform = function() {
						var selected = this.getSelected();
						$(this.element).css(this.transformProp, 'translateZ(-' + this.radius + 'px) ' + this.rotateFn + '(' + this.rotation + 'deg)');
						$(selected.elem).css("opacity", 1);
						$("figure:not(.a" + selected.angle + ", .hidden)", this.element).css("opacity", "0.5");

						if (selected.angle != this.last_angle && [0,90,180,270].indexOf(selected.angle) >= 0) {
							this.last_angle = selected.angle;
							this.update(selected);
						}
					};

					this.getNearest = function (deg) {
						deg = deg || this.rotation;
							var th = (this.theta / 2);
							var n = 360;
						var angle = ((deg + th) % n + n) % n;
						angle = angle - angle % this.theta;
						return angle;
					};

					this.getSelected = function () {
						var nearest = this.getNearest();    	
						for (var i in this.mapping) {
							if (this.mapping[i].angle == nearest) {
								return this.mapping[i];
								break;
							}
						}
					};

					this.setRotation = function(deg) {
						this.rotation = deg;
					};

					this.getRotation = function() {
						return this.rotation;
					};

					this.deltaRotate = function(delta) {
						var rotation = this.getRotation();
						this.setRotation(this.rotation + delta);
						this.transform();
					};

					this.nearestRotate= function() {
						this.setRotation(this.getNearest());
						this.transform();
					};

					//setup
					var c = 0;
					for (var i=0; i < this.panelCount; i++) {
						var j = c;
						if (c >= (this.panelCount / 2)) {
							j = this.data.length - (this.panelCount - c);
						}
						c++;
						this.mapping.push(panelfactory(i, drumfactory(this.data, j), this));
					}
					this.transform();

					//events
					var hammertime = Hammer(this.element.parentNode.parentNode, {
						prevent_default: true,
						no_mouseevents: true
					});
					
					hammertime.on("dragstart", (function (e) { 
						this.distance = 0;
					}).bind(this) );

					hammertime.on("drag", (function (e) {
						var evt = ["up", "down"];
						if (evt.indexOf(e.gesture.direction)>=0) {
							this.deltaRotate(Math.round(e.gesture.deltaY - this.distance) * -1);
							this.distance = e.gesture.deltaY;
						}
					}).bind(this) );

					hammertime.on("dragend", (function (e) {
						this.nearestRotate();

				    	var selected = this.getSelected().dataModel;
						console.log(selected.getValue() + ":" + selected.getText());

					}).bind(this) );

				})(el, data, panelfactory, drumfactory);
			},
		    _create: function() {
		    	$(this.element).hide();
		    	var my = this.element[0];
		    	my.data = [];

		    	for (var i=0; i<my.children.length; i++) {
		    		my.data.push({ value: $(my.children[i]).attr('value'), text: $(my.children[i]).text() })
		    	}

		    	var wrapper = document.createElement( "div" );
				$(wrapper).addClass("drum-wrapper");
				$(this.element).after(wrapper);

		        var container = document.createElement( "div" );
				$(container).addClass("container");

				var drum = document.createElement( "div" );
				$(drum).addClass("drum");
				$(drum).appendTo(container);

				$(container).appendTo(wrapper);

				my.drum = this.init(drum, my.data, this.panelfactory, this.drumfactory);
		    }
		});

		$("#country").drum();
		$("#n45").drum();
	});
	</script>
</body>
</html>